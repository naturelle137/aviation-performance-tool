#!/bin/sh


echo "--------------------------------------------------------"
echo "Quality Gate 1: Pre-Push Verification"
echo "--------------------------------------------------------"

# 1. Frontend Checks
echo "1. Running Frontend Checks..."
cd frontend || exit 1

echo "   --> Type Checking..."
if ! npm run type-check; then
  echo "❌ Frontend type check failed. Push aborted."
  exit 1
fi

cd ..


# 3. Tests
echo "3. Running Tests..."

# Frontend Tests
echo "   --> Frontend Tests with Coverage..."
cd frontend || exit 1
if ! npm run test:coverage; then
  echo "❌ Frontend tests failed. Push aborted."
  exit 1
fi
cd ..

# Backend Tests
if [ -d "backend" ]; then
    echo "   --> Backend Tests..."
    cd backend || exit 1
    if [ -f ".venv/Scripts/python" ]; then
        # Check P1 (Safety/Core) with 90% coverage
        echo "   --> Backend P1 Core Tests (90% coverage)..."
        if ! .venv/Scripts/python -m pytest app/services/*/core.py -o "addopts=-v" --cov=app --cov-fail-under=90; then
            echo "❌ Backend P1 Core tests failed (Target: 90%). Push aborted."
            exit 1
        fi

        # Check P2 (Operational/Logic) with 80% coverage
        echo "   --> Backend P2 Logic Tests (80% coverage)..."
        if ! .venv/Scripts/python -m pytest app/services/*/logic.py -o "addopts=-v" --cov=app --cov-fail-under=80; then
            echo "❌ Backend P2 Logic tests failed (Target: 80%). Push aborted."
            exit 1
        fi
    else
        # Check P1 (Safety/Core) with 90% coverage
        echo "   --> Backend P1 Core Tests (90% coverage)..."
        if ! pytest app/services/*/core.py -o "addopts=-v" --cov=app --cov-fail-under=90; then
             echo "❌ Backend P1 Core tests failed (Target: 90%). Push aborted."
             exit 1
        fi

        # Check P2 (Operational/Logic) with 80% coverage
        echo "   --> Backend P2 Logic Tests (80% coverage)..."
        if ! pytest app/services/*/logic.py -o "addopts=-v" --cov=app --cov-fail-under=80; then
             echo "❌ Backend P2 Logic tests failed (Target: 80%). Push aborted."
             exit 1
        fi
    fi
    cd ..
fi

echo "✅ All Quality Gate checks passed. Pushing..."
