#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "--------------------------------------------------------"
echo "Quality Gate 1: Pre-Push Verification"
echo "--------------------------------------------------------"

# 1. Frontend Checks
echo "1. Running Frontend Checks..."
cd frontend || exit 1

echo "   --> Type Checking..."
if ! npm run type-check; then
  echo "❌ Frontend type check failed. Push aborted."
  exit 1
fi

cd ..


# 3. Tests
echo "3. Running Tests..."

# Frontend Tests
echo "   --> Frontend Tests with Coverage..."
cd frontend || exit 1
if ! npm run test:coverage; then
  echo "❌ Frontend tests failed. Push aborted."
  exit 1
fi
cd ..

# Backend Tests
if [ -d "backend" ]; then
    echo "   --> Backend Tests..."
    cd backend || exit 1
    if [ -f ".venv/Scripts/python" ]; then
        if ! .venv/Scripts/python -m pytest -m p1 --cov=app --cov-fail-under=90; then
            echo "❌ Backend tests failed. Push aborted."
            exit 1
        fi
    else
        if ! pytest -m p1 --cov=app --cov-fail-under=90; then
             echo "❌ Backend tests failed. Push aborted."
             exit 1
        fi
    fi
    cd ..
fi

echo "✅ All Quality Gate checks passed. Pushing..."
